<!DOCTYPE html>
<html lang="en" data-ng-app="test">
<head>
    <meta charset="UTF-8">
    <title>DEMO</title>
    <link rel="stylesheet" href="js/kendo-ui/styles/kendo.common.min.css" />
    <link rel="stylesheet" href="js/kendo-ui/styles/kendo.default.min.css" />
    <link rel="stylesheet" href="js/kendo-ui/styles/kendo.default.mobile.min.css" />
    <link rel="stylesheet" href="js/getorgchart/getorgchart.css" />
    <style>
        .get-org-chart .get-left,
        .get-org-chart .get-right,
        .get-org-chart .get-up, .get-down,
        .get-org-chart .get-oc-tb,
        g[data-btn-action],
        g[data-node-id] .get-text-0{
            display: none !important;
        }
        .get-box:hover{
            fill: red;
        }
    </style>
</head>
<body data-ng-controller="testCtrl">
<div id="chart"
     kendo-tooltip="tooltipInstance"
     k-options="tooltipOptions"
     >
</div>
<ul data-ng-if="isChartRendered"
    kendo-context-menu
    k-target="'#chart'"
    k-filter="'g[data-node-id]'"
    k-on-select="onSelect(kendoEvent)">
    <li data-tag="view">View claim</li>
    <li data-tag="addright">Add claim (right)</li>
    <li data-tag="addleft">Add claim (left)</li>
    <li data-tag="addbelow">Add claim (below)</li>
    <li data-tag="copy">Copy claim</li>
    <li data-tag="delete">Delete claim</li>
</ul>
<script id="tooltipTemplate" type="text/x-kendo-template">
    # var node = getNode(target) #
    <div id='testId' class='testClass' style='font-size:15px; color:black; background-color:white;'>
        <p>#= foo.Title #</p>
    </div>
</script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="js/jquery.js"></script>
<script src="bower_components/angular/angular.js"></script>
<script src="js/kendo-ui/kendo.all.js"></script>
<script src="js/getorgchart/getorgchart.js"></script>
<script>
    var app = angular.module('test', ['kendo.directives']);
    app.controller('testCtrl', function($scope, $timeout, $location){
        $scope.minId = 1;
        $scope.maxId = 10000001;
        $scope.tooltipOptions = {
            visible: true,
            target: "#chart",
            filter: "g[data-node-id]",
            content: kendo.template($("#template").html())
        };
        $scope.getNode = function($target){
            var nodeId = $target.data('nodeId');
            return _.find($scope.dataSource, {id: nodeId});
        };
        window.getNode = $scope.getNode;
        $scope.generateId = function(){
            return $scope.generateIdBetween($scope.minId, $scope.maxId)
        };
        $scope.findMinMax = function(a, b){
            var res = {};
            if(a > b) {
                res.min = b;
                res.max = a;
            }
            else{
                res.min = a;
                res.max = b;
            }
            return res;
        };
        $scope.generateIdBetween = function(a, b){
            var res = $scope.findMinMax(a, b);
            var min = res.min,
                max = res.max;
            return Math.floor(Math.random() * (max - min)) + min;
        };
        $scope.dataSource = [
            { id: $scope.generateId(), parentId: null, Name: 'Root Item', Title: "aaaa", HightLight: 'bbbb'}
        ];
        $scope.copyChild = function(node, position){
            var siblings = _.filter($scope.dataSource, { parentId: node.parentId });
            siblings = _.sortBy(siblings, [function(o) { return o.id; }]);
            var currentIndex = _.findIndex(siblings, {id: node.id});
            var nextId;
            if((position === "RIGHT" && currentIndex === siblings.length - 1) ||
                    (position === "LEFT" && currentIndex === 0) ||
                    siblings.length === 1){
                if(position === "RIGHT")
                    nextId = $scope.generateIdBetween(node.id + 1, $scope.maxId);
                else
                    nextId = $scope.generateIdBetween($scope.minId, node.id);
            }
            else {
                var nextSiblingId;
                if(position === "RIGHT")
                    nextSiblingId = siblings[currentIndex + 1].id;
                else
                    nextSiblingId = siblings[currentIndex - 1].id;
                nextId = $scope.generateIdBetween(node.id, nextSiblingId);
            }
            var newNode = {id: nextId, parentId: node.parentId, Name: "Copy Item", Title: "aaaa", HightLight: 'bbbb'};
            $scope.dataSource.push(newNode);
        };
        $scope.addLeft = function(node){
            $scope.copyChild(node, "LEFT");
        };
        $scope.addRight = function(node){
            $scope.copyChild(node, "RIGHT");
        };
        $scope.onSelect = function(e) {
            var command = $(e.item).data('tag');
            var nodeId = $(e.target).data('nodeId');
            var index = _.findIndex($scope.dataSource, {id: nodeId});
            var node = $scope.dataSource[index];
            switch (command.toUpperCase()){
                case "ADDBELOW":
                {
                    var newNode = { id: $scope.generateId(), parentId: nodeId, Name: "New Item"};
                    $scope.dataSource.push(newNode);
                }
                    break;

                case "DELETE":
                {
                    function _deleteRecusive(nodeId){
                        for(var i=0; i<$scope.dataSource.length; ++i){
                            var node = $scope.dataSource[i];
                            if(node.id === nodeId) {
                                $scope.dataSource.splice(i, 1);
                                --i;
                            }
                            else if(node.parentId === nodeId){
                                _deleteRecusive(node.id);
                                $scope.dataSource.splice(i, 1);
                                --i;
                            }
                        }
                    }
                    _deleteRecusive(nodeId);
                }
                    break;

                case "COPY":
                {
                    if(node.parentId !== null) {
                        $scope.addRight(node);
                    }
                }
                    break;

                case "ADDLEFT":
                {
                    if(node.parentId !== null) {
                        $scope.addLeft(node);
                    }
                }
                    break;

                case "ADDRIGHT":
                {
                    if(node.parentId !== null) {
                        $scope.addRight(node);
                    }
                }
                    break;

                case "VIEW":
                {
                    $location.path('/abc');
                }
                    break;

                default:
                    break;
            }
            if(!$scope.dataSource.length)
                $scope.dataSource = [{}];
            $scope.renderChart();
        };
        $scope.renderChart = function(){
            var chart = new getOrgChart($scope.$chart, {
                primaryFields: ["Lastname", "Title", "Name"],
                scale: 0.5,
                siblingSeparation: 150,
                enableZoom: false,
                orientation: getOrgChart.RO_TOP_PARENT_LEFT,
                enableEdit: false,
                dataSource: angular.copy($scope.dataSource)
            });
        };

        $timeout(function() {
            $scope.$chart = document.getElementById('chart');
            $scope.renderChart();
            $scope.isChartRendered = true;
        });
    });
</script>
</body>
</html>